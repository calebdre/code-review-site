<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Code Review Site - Submit</title>
        <link rel="stylesheet" href="codemirror.css">
        <link rel="stylesheet" href="taggle.css">
        <link rel="stylesheet" href="shared.css">
        <link rel="stylesheet" href="submit-style.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400|Raleway:500" rel="stylesheet">
    </head>
    <body>

        <div class="submission-container">
            <label for="input-context">Context</label>
            <input class="input context-input" id="input-context" type="text" placeholder="Give some context around the code you're getting reviewed">
            <ul class="file-list"></ul>
            <div class="input-group">
                <input class="filename-input input" id="input-filename" type="text" placeholder="filename (example.js)">
                <button id="add-file" class="button button-dark button-small">add another file</button>
            </div>
            <textarea name="code-input" id="input-code" cols="30" rows="10"></textarea>
            <div id="input-tags" class="input-tags"></div>
            <button class="button-dark button submit-button">Submit</button>
        </div>

        <script src="firebase4.0.js"></script>
        <script src="jquery-3.2.1.slim.min.js"></script>
        <script src="taggle.min.js"></script>
        <script src="codemirror.js"></script>
        <script src="loadmode.js"></script>
        <script src="placeholder.js"></script>
        <script src="meta.js"></script>
        <script src="Utils.js"></script>
        <script>


            class FileList {
                constructor() {
                    this._files = [];
                    this._fileList = $(".file-list");
                    this._nameInput =  $("#input-filename");
                    this._activeIndex = 0;
                }

                applyListeners() {
                    $("#add-file").click(e => {
                       const currentFileInfo = {
                           "name": $("#input-filename").val(),
                           "content": editor.getValue()
                       };

                       this.append(currentFileInfo);
                    });
                }

                append(fileInfo) {
                    const duplicateIndex = this._files.reduce((accumulator, item, index) => {
                        return item["name"] === fileInfo["name"] ? index : accumulator;
                    }, -1);

                    if (duplicateIndex !== -1) {
                        const el = this._fileList.find(".file").eq(duplicateIndex);

                        el.addClass("bounce");
                        this._nameInput.prop("disabled", true)
                        setTimeout(() => {
                            el.removeClass("bounce");
                            this._nameInput.prop("disabled", false)
                        }, 1200);

                        return;
                    }

                    const elData = {"class": "file", "tag": "li", "children": [
                            {"class": "file-name", "tag": "span", "data": fileInfo["name"]},
                            {"class": "close", "tag": "button", "data": "x"}
                        ]};

                    const $html = composeHtml(elData);

                    this._files.push(fileInfo);
                    this._fileList.append($html);;
                    $html.find(".close").click(e => {
                        this.remove($(e.currentTarget).parent().index());
                    });
                    $html.click(e => {
                        this.show($(e.currentTarget).index());
                    })

                    this._activeIndex = this._files.length;
                    this._nameInput.val("");
                    editor.setValue("");
                }

                saveCurrentData() {
                    this._files[this._activeIndex] = {
                        name: this._nameInput.val(),
                        content: editor.getValue()
                    }
                    this._fileList.find(".file")
                        .eq(this._activeIndex)
                        .find(".file-name")
                        .text(this._nameInput.val())
                }

                show(index) {
                    this.saveCurrentData();
                    const fileData = this._files[index];
                    this._fileList
                        .find(".file.active")
                        .removeClass("active");

                    this._fileList
                        .find(".file")
                        .eq(index)
                        .addClass("active");

                    this._nameInput.val(fileData["name"]);
                    editor.setValue(fileData["content"]);
                    this._activeIndex = index;
                }

                remove(index) {
                    this._files.splice(index, 1);
                    this._fileList
                        .find(".file")
                        .eq(index)
                        .remove();

                    this._nameInput.val("");
                    editor.setValue("");
                }
            }

            //https://dribbble.com/shots/1856405-Taringa-Creacion-de-post
            CodeMirror.modeURL = "/code_review_site_not_react/mode/%N/%N.js"
            var editor = CodeMirror.fromTextArea($("#input-code").get(0), {
                "lineNumbers": true,
                "placeholder": "console.log('Hello world!');"
            });

            const tags = new Taggle("input-tags", {
                duplicateTagClass: 'bounce',
                placeholder: "Type some tags related to your code"
            })
            $("#input-filename").keyup((e) => {
               const input = $(e.currentTarget).val();
               const info = CodeMirror.findModeByFileName(input);
               if (info) {
                   editor.setOption("mode", info.mime);
                   CodeMirror.autoLoadMode(editor, info.mode)
                   $(".file-type").text(`${info.name}`);
               }
            });

            const filetypeData = {
                "class": "file-type", "tag": "span"
            };

            $(".CodeMirror").append(composeHtml(filetypeData));

            new FileList().applyListeners();
        </script>
    </body>
</html>